<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CSR Project Tracker</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#2563eb; --primary-dark:#1e40af; --secondary:#64748b;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --text-light:#64748b; --border:#e2e8f0;
      --purple:#8b5cf6; --cyan:#06b6d4;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px}
    .login-box{background:white;padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:420px}
    .login-box h1{margin-bottom:10px;color:var(--text);font-size:28px}
    .login-box p{color:var(--text-light);margin-bottom:30px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--text)}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary)}
    .btn{width:100%;padding:12px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-primary{background:var(--primary);color:white}
    .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.25)}
    .btn-secondary{background:var(--secondary);color:white;margin-top:10px}
    .btn-secondary:hover{background:#475569}
    .btn-danger{background:var(--danger);color:white}
    .btn-ghost{background:transparent;border:2px solid var(--border);color:var(--text)}
    .btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
    .app-container{display:none}
    .header{background:white;padding:16px 24px;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .header h1{font-size:22px;color:var(--primary)}
    .header-right{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .user-info{color:var(--text-light);font-size:14px}
    .btn-logout{padding:8px 14px;background:var(--danger);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600}
    .nav-tabs{background:white;padding:0 24px;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;gap:8px;overflow-x:auto}
    .nav-tab{padding:14px 18px;border:none;background:none;cursor:pointer;font-weight:600;color:var(--text-light);border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap}
    .nav-tab:hover{color:var(--primary)}
    .nav-tab.active{color:var(--primary);border-bottom-color:var(--primary)}
    .main-content{padding:24px;max-width:1400px;margin:0 auto}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card{background:var(--card);border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:24px}
    .card h2{margin-bottom:12px;font-size:20px;color:var(--text)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}
    .stat-card{background:white;padding:24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);border-left:4px solid var(--primary)}
    .stat-card.warning{border-left-color:var(--warning)}
    .stat-card.danger{border-left-color:var(--danger)}
    .stat-card.success{border-left-color:var(--success)}
    .stat-label{color:var(--text-light);font-size:14px;margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:800;color:var(--text)}
    .table-container{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{background:var(--bg);padding:12px;text-align:left;font-weight:800;color:var(--text);border-bottom:2px solid var(--border)}
    td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
    tr:hover{background:var(--bg)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .badge-high{background:#fee2e2;color:#dc2626}
    .badge-medium{background:#fef3c7;color:#b45309}
    .badge-low{background:#dbeafe;color:#1d4ed8}
    .badge-pending{background:#e0e7ff;color:#4338ca}
    .badge-ongoing{background:#dbeafe;color:#0284c7}
    .badge-completed{background:#d1fae5;color:#059669}
    .badge-onhold{background:#fed7aa;color:#c2410c}
    .muted{color:var(--text-light)}
    .hidden{display:none !important}

    /* Kanban */
    .kanban-board{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
    @media (max-width:1024px){.kanban-board{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.kanban-board{grid-template-columns:1fr}}
    .kanban-column{background:var(--bg);border-radius:12px;padding:14px;border:2px dashed transparent;min-height:280px}
    .kanban-column.drag-over{border-color:var(--primary);background:#eff6ff}
    .kanban-header{font-weight:900;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .kanban-count{font-size:12px;color:var(--text-light);font-weight:800}
    .kanban-card{background:white;padding:14px;border-radius:10px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:grab;transition:transform .15s, box-shadow .15s}
    .kanban-card:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .kanban-card:active{cursor:grabbing}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .modal-content{background:white;border-radius:12px;padding:28px;max-width:820px;width:100%;max-height:90vh;overflow:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:10px}
    .modal-header h2{margin:0}
    .close-modal{background:none;border:none;font-size:26px;cursor:pointer;color:var(--text-light)}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .form-grid .form-group.full{grid-column:1/-1}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row-between{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}

    /* Calendar */
    .calendar-wrap{display:flex;flex-direction:column;gap:14px}
    .calendar-toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .calendar-title{font-weight:900;font-size:18px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .cal-dow{font-size:12px;color:var(--text-light);font-weight:900;text-transform:uppercase}
    .cal-cell{background:white;border:1px solid var(--border);border-radius:12px;min-height:110px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .cal-cell.muted{background:#f1f5f9;color:#94a3b8}
    .cal-day{display:flex;justify-content:space-between;align-items:center;font-weight:900}
    .cal-events{display:flex;flex-direction:column;gap:6px}
    .cal-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;line-height:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:100%}
    .pill-project{background:#dbeafe;color:#1d4ed8}
    .pill-task{background:#d1fae5;color:#065f46}
    .pill-leave{background:#ede9fe;color:#5b21b6}
    .pill-comm{background:#cffafe;color:#155e75}

    /* Communications color-coded rows */
    .comm-row-high{background:#fff1f2}
    .comm-row-medium{background:#fffbeb}
    .comm-row-low{background:#eff6ff}
    .comm-row-high:hover,.comm-row-medium:hover,.comm-row-low:hover{filter:brightness(0.98)}
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-container" id="loginScreen">
    <div class="login-box">
      <h1>CSR Tracker</h1>
      <p>Sign in to manage your projects</p>

      <div id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="Enter your email" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter your password" />
        </div>
        <button class="btn btn-primary" id="loginBtn">Sign In</button>
        <button class="btn btn-secondary" id="showSignupBtn">Create Account</button>
      </div>

      <div id="signupForm" class="hidden">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signupEmail" placeholder="Enter your email" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signupPassword" placeholder="Create a password" />
        </div>
        <button class="btn btn-primary" id="signupBtn">Create Account</button>
        <button class="btn btn-secondary" id="showLoginBtn">Back to Login</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <div class="header">
      <h1>CSR Project Tracker</h1>
      <div class="header-right">
        <span class="user-info" id="userEmail"></span>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="projects">Projects</button>
      <button class="nav-tab" data-tab="kanban">Kanban</button>
      <button class="nav-tab" data-tab="analytics">Analytics</button>
      <button class="nav-tab" data-tab="calendar">Calendar</button>
      <button class="nav-tab" data-tab="communications">Communications</button>
      <button class="nav-tab hidden" id="auditTab" data-tab="audit">Audit Trail</button>
    </div>

    <div class="main-content">
      <!-- Dashboard -->
      <div class="tab-content active" id="dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Active Projects</div>
            <div class="stat-value" id="activeProjects">0</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-label">Overdue Tasks</div>
            <div class="stat-value" id="overdueTasks">0</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-label">Due This Week</div>
            <div class="stat-value" id="dueThisWeek">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Completed Tasks</div>
            <div class="stat-value" id="completedTasks">0</div>
          </div>
        </div>

        <div class="card">
          <div class="row-between" style="margin-bottom:10px">
            <h2 style="margin:0">High Priority Tasks</h2>
            <span class="muted" style="font-weight:800;font-size:12px">Top 10</span>
          </div>
          <div class="table-container">
            <table id="highPriorityTable">
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Project</th>
                  <th>Owner</th>
                  <th>Deadline</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Projects -->
      <div class="tab-content" id="projects">
        <div class="card">
          <div class="row-between" style="margin-bottom: 16px;">
            <h2 style="margin:0;">Projects</h2>
            <button class="btn btn-primary" style="width:auto;padding:10px 18px;" id="newProjectBtn">+ New Project</button>
          </div>
          <div class="table-container">
            <table id="projectsTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Owner</th>
                  <th>Budget (AED)</th>
                  <th>Completion</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Kanban -->
      <div class="tab-content" id="kanban">
        <div class="card" style="margin-bottom:16px">
          <h2 style="margin-bottom:8px">Kanban (Drag & Drop)</h2>
          <p class="muted" style="font-weight:700">Drag a project card between columns to change its status.</p>
        </div>
        <div class="kanban-board">
          <div class="kanban-column" data-status="Pending">
            <div class="kanban-header">Pending <span class="kanban-count" id="count-pending">0</span></div>
            <div id="kanban-pending"></div>
          </div>
          <div class="kanban-column" data-status="Ongoing">
            <div class="kanban-header">Ongoing <span class="kanban-count" id="count-ongoing">0</span></div>
            <div id="kanban-ongoing"></div>
          </div>
          <div class="kanban-column" data-status="On Hold">
            <div class="kanban-header">On Hold <span class="kanban-count" id="count-onhold">0</span></div>
            <div id="kanban-onhold"></div>
          </div>
          <div class="kanban-column" data-status="Completed">
            <div class="kanban-header">Completed <span class="kanban-count" id="count-completed">0</span></div>
            <div id="kanban-completed"></div>
          </div>
        </div>
      </div>

      <!-- Analytics -->
      <div class="tab-content" id="analytics">
        <div class="card">
          <h2>Analytics Dashboard</h2>
          <p class="muted" style="font-weight:700;margin-bottom:12px">Select a project to view detailed analytics</p>
          <div class="form-group">
            <select id="analyticsProjectSelect">
              <option value="">Select a project...</option>
            </select>
          </div>
          <div id="analyticsContent" class="muted" style="font-weight:700"></div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="tab-content" id="calendar">
        <div class="card">
          <div class="row-between" style="margin-bottom:10px">
            <div>
              <h2 style="margin:0">Calendar (Projects + Tasks + Leaves + Comms)</h2>
              <p class="muted" style="font-weight:700">One view, everything important on the timeline.</p>
            </div>
            <button class="btn btn-primary" style="width:auto;padding:10px 18px" id="newLeaveBtn">+ Add Leave</button>
          </div>

          <div class="calendar-wrap">
            <div class="calendar-toolbar">
              <div class="row" style="gap:8px">
                <button class="btn btn-ghost" style="width:auto;padding:8px 12px" id="calPrev">←</button>
                <button class="btn btn-ghost" style="width:auto;padding:8px 12px" id="calToday">Today</button>
                <button class="btn btn-ghost" style="width:auto;padding:8px 12px" id="calNext">→</button>
              </div>
              <div class="calendar-title" id="calTitle"></div>
              <div class="row" style="gap:8px">
                <span class="cal-pill pill-project"><span class="dot" style="background:var(--primary)"></span>Project</span>
                <span class="cal-pill pill-task"><span class="dot" style="background:var(--success)"></span>Task</span>
                <span class="cal-pill pill-leave"><span class="dot" style="background:var(--purple)"></span>Leave</span>
                <span class="cal-pill pill-comm"><span class="dot" style="background:var(--cyan)"></span>Comms</span>
              </div>
            </div>

            <div class="calendar-grid" id="calDow"></div>
            <div class="calendar-grid" id="calGrid"></div>
          </div>
        </div>
      </div>

      <!-- Communications -->
      <div class="tab-content" id="communications">
        <div class="card">
          <div class="row-between" style="margin-bottom:16px">
            <div>
              <h2 style="margin:0">Communications</h2>
              <p class="muted" style="font-weight:700">Color-coded by priority for quick scanning.</p>
            </div>
            <button class="btn btn-primary" style="width:auto;padding:10px 18px" id="newCommBtn">+ New Communication</button>
          </div>

          <div class="table-container">
            <table id="commsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Subject</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Deadline</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Audit -->
      <div class="tab-content" id="audit">
        <div class="card">
          <h2>Audit Trail</h2>
          <div class="table-container">
            <table id="auditTable">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Type</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal (Create) -->
  <div class="modal" id="projectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Project</h2>
        <button class="close-modal" data-modal="projectModal">×</button>
      </div>
      <form id="projectForm">
        <div class="form-grid">
          <div class="form-group full">
            <label>Project Name *</label>
            <input type="text" id="projectName" required />
          </div>
          <div class="form-group">
            <label>Priority *</label>
            <select id="projectPriority" required>
              <option value="High">High</option>
              <option value="Medium" selected>Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status *</label>
            <select id="projectStatus" required>
              <option value="Pending">Pending</option>
              <option value="Ongoing" selected>Ongoing</option>
              <option value="On Hold">On Hold</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="form-group">
            <label>Budget (AED) *</label>
            <input type="number" id="projectBudget" required />
          </div>
          <div class="form-group">
            <label>Beneficiaries *</label>
            <input type="number" id="projectBeneficiaries" required />
          </div>
          <div class="form-group">
            <label>Owner *</label>
            <input type="text" id="projectOwner" required />
          </div>
          <div class="form-group">
            <label>Launch Date *</label>
            <input type="date" id="projectLaunchDate" required />
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Save Project</button>
      </form>
    </div>
  </div>

  <!-- Project View Modal (Tasks inside) -->
  <div class="modal" id="projectViewModal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h2 style="margin:0" id="pvTitle">Project</h2>
          <div class="muted" style="font-weight:800" id="pvMeta"></div>
        </div>
        <button class="close-modal" data-modal="projectViewModal">×</button>
      </div>

      <div class="card" style="padding:16px;margin-bottom:16px">
        <h3 style="margin:0 0 10px 0;font-size:16px">Add Task</h3>
        <form id="taskForm">
          <div class="form-grid">
            <div class="form-group full">
              <label>Task Name *</label>
              <input type="text" id="taskName" required />
            </div>
            <div class="form-group">
              <label>Priority *</label>
              <select id="taskPriority" required>
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status *</label>
              <select id="taskStatus" required>
                <option value="Pending" selected>Pending</option>
                <option value="Ongoing">Ongoing</option>
                <option value="On Hold">On Hold</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <div class="form-group">
              <label>Owner *</label>
              <input type="text" id="taskOwner" required />
            </div>
            <div class="form-group">
              <label>Deadline *</label>
              <input type="date" id="taskDeadline" required />
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Save Task</button>
        </form>
      </div>

      <div class="card" style="padding:16px">
        <div class="row-between" style="margin-bottom:10px">
          <h3 style="margin:0;font-size:16px">Tasks</h3>
          <span class="muted" style="font-weight:800" id="pvTaskCount">0</span>
        </div>
        <div class="table-container">
          <table id="pvTasksTable">
            <thead>
              <tr>
                <th>Task</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Owner</th>
                <th>Deadline</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Leave Modal -->
  <div class="modal" id="leaveModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Leave</h2>
        <button class="close-modal" data-modal="leaveModal">×</button>
      </div>
      <form id="leaveForm">
        <div class="form-group">
          <label>Member *</label>
          <input type="text" id="leaveMember" required />
        </div>
        <div class="form-group">
          <label>Start Date *</label>
          <input type="date" id="leaveStart" required />
        </div>
        <div class="form-group">
          <label>End Date *</label>
          <input type="date" id="leaveEnd" required />
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="leaveNotes" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save Leave</button>
      </form>
    </div>
  </div>

  <!-- Communication Modal -->
  <div class="modal" id="commModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Communication</h2>
        <button class="close-modal" data-modal="commModal">×</button>
      </div>
      <form id="commForm">
        <div class="form-grid">
          <div class="form-group full">
            <label>Subject *</label>
            <input type="text" id="commSubject" required />
          </div>
          <div class="form-group">
            <label>Type *</label>
            <select id="commType" required>
              <option value="Announcement">Announcement</option>
              <option value="Email">Email</option>
              <option value="Event comms">Event comms</option>
              <option value="Reminder">Reminder</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status *</label>
            <select id="commStatus" required>
              <option value="Idea">Idea</option>
              <option value="In progress">In progress</option>
              <option value="Pending approval">Pending approval</option>
              <option value="Done">Done</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priority *</label>
            <select id="commPriority" required>
              <option value="High">High</option>
              <option value="Medium" selected>Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label>Deadline *</label>
            <input type="date" id="commDeadline" required />
          </div>
          <div class="form-group full">
            <label>Content Owner *</label>
            <input type="text" id="commOwner" required />
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Save Communication</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, updateDoc,
      orderBy, serverTimestamp, getDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration - KEEP AS YOU SHARED
    const firebaseConfig = {
      apiKey: "AIzaSyD_tx2UozhAVZbCMuavK9yLqFej6LuWarw",
      authDomain: "csr-ph.firebaseapp.com",
      projectId: "csr-ph",
      storageBucket: "csr-ph.firebasestorage.app",
      messagingSenderId: "1050637353999",
      appId: "1:1050637353999:web:ef60b068cc2e6c52d0cf7a",
      measurementId: "G-1JV8EC99PB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.currentUser = null;
    window.userRole = 'csr';
    window.projects = [];
    window.tasks = [];
    window.communications = [];
    window.leaves = [];
    window.audit = [];

    // Calendar state
    let calYear = new Date().getFullYear();
    let calMonth = new Date().getMonth(); // 0-11

    // Project view state
    let currentProjectId = null;

    // ---------- Auth State ----------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        window.currentUser = user;
        document.getElementById('userEmail').textContent = user.email;
        await loadUserRole(user.uid);
        await loadAllData();
        showApp();
      } else {
        showLoginScreen();
      }
    });

    // NOTE FIX: direct role doc read by uid (no query)
    async function loadUserRole(uid) {
      try {
        const roleRef = doc(db, 'roles', uid);
        const snap = await getDoc(roleRef);

        if (snap.exists()) {
          window.userRole = snap.data().role || 'csr';
        } else {
          // create default csr role
          await setDoc(roleRef, { uid, role: 'csr' });
          window.userRole = 'csr';
        }

        if (window.userRole === 'admin') {
          document.getElementById('auditTab').classList.remove('hidden');
        } else {
          document.getElementById('auditTab').classList.add('hidden');
        }
      } catch (error) {
        console.error('Error loading role:', error);
        window.userRole = 'csr';
      }
    }

    async function loadAllData() {
      try {
        const projectsSnap = await getDocs(collection(db, 'projects'));
        window.projects = projectsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.projects.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

        const tasksSnap = await getDocs(collection(db, 'tasks'));
        window.tasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.tasks.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

        const commsSnap = await getDocs(collection(db, 'communications'));
        window.communications = commsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.communications.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

        const leavesSnap = await getDocs(collection(db, 'leaves'));
        window.leaves = leavesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.leaves.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

        if (window.userRole === 'admin') {
          const auditSnap = await getDocs(collection(db, 'audit'));
          window.audit = auditSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          window.audit.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        } else {
          window.audit = [];
        }

        renderDashboard();
        renderProjects();
        renderKanban();
        renderCommunications();
        renderAnalyticsSelect();
        renderCalendar();
        renderAudit();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    // ---------- UI ----------
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
    }
    function showLoginScreen() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appContainer').style.display = 'none';
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
    }
    function showSignupForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');
    }
    function showLoginForm() {
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    // Fix: do not rely on global "event"
    function switchTab(tabName, clickedBtn) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      clickedBtn.classList.add('active');
      document.getElementById(tabName).classList.add('active');

      // rerender calendar when opening tab
      if (tabName === 'calendar') renderCalendar();
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }
    function closeModalById(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ---------- Auth Actions ----------
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert('Login failed: ' + error.message);
      }
    }

    async function handleSignup() {
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'roles', userCredential.user.uid), {
          uid: userCredential.user.uid,
          role: 'csr'
        });
      } catch (error) {
        alert('Signup failed: ' + error.message);
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        showLoginScreen();
      } catch (error) {
        alert('Logout failed: ' + error.message);
      }
    }

    // ---------- Data Actions ----------
    async function saveProject(e) {
      e.preventDefault();
      const btn = document.querySelector('#projectForm button[type="submit"]');
if (btn.disabled) return;
btn.disabled = true;
const old = btn.textContent;
btn.textContent = 'Saving...';


      const projectData = {
        name: document.getElementById('projectName').value.trim(),
        priority: document.getElementById('projectPriority').value,
        status: document.getElementById('projectStatus').value,
        budget: parseFloat(document.getElementById('projectBudget').value),
        beneficiaries: parseInt(document.getElementById('projectBeneficiaries').value, 10),
        owner: document.getElementById('projectOwner').value.trim(),
        launchDate: document.getElementById('projectLaunchDate').value,
        createdAt: serverTimestamp(),
        createdBy: window.currentUser?.email || ''
      };

      try {
        await addDoc(collection(db, 'projects'), projectData);

        if (window.userRole === 'admin') {
          await addDoc(collection(db, 'audit'), {
            timestamp: serverTimestamp(),
            user: window.currentUser.email,
            action: 'created',
            type: 'project',
            details: projectData.name
          });
        }

        closeModalById('projectModal');
        document.getElementById('projectForm').reset();
        await loadAllData();
  } catch (error) {
    alert('Error saving project: ' + error.message);
  } finally {
    btn.textContent = old;
    btn.disabled = false;
  }
    }

    async function saveLeave(e) {
      e.preventDefault();
      const btn = document.querySelector('#leaveForm button[type="submit"]');
      if (btn.disabled) return;
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      const leaveData = {
        member: document.getElementById('leaveMember').value.trim(),
        startDate: document.getElementById('leaveStart').value,
        endDate: document.getElementById('leaveEnd').value,
        notes: document.getElementById('leaveNotes').value.trim(),
        createdAt: serverTimestamp(),
        createdBy: window.currentUser?.email || ''
      };

      try {
        await addDoc(collection(db, 'leaves'), leaveData);

        if (window.userRole === 'admin') {
          await addDoc(collection(db, 'audit'), {
            timestamp: serverTimestamp(),
            user: window.currentUser.email,
            action: 'created',
            type: 'leave',
            details: `${leaveData.member} (${leaveData.startDate} → ${leaveData.endDate})`
          });
        }

        closeModalById('leaveModal');
        document.getElementById('leaveForm').reset();
        await loadAllData();
      } catch (error) {
        alert('Error saving leave: ' + error.message);
      }finally {
    btn.textContent = old;
    btn.disabled = false;
  }
    }

    async function saveComm(e) {
      e.preventDefault();
      const btn = document.querySelector('#commForm button[type="submit"]');
      if (btn.disabled) return;
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      const commData = {
        subject: document.getElementById('commSubject').value.trim(),
        type: document.getElementById('commType').value,
        status: document.getElementById('commStatus').value,
        priority: document.getElementById('commPriority').value,
        deadline: document.getElementById('commDeadline').value,
        owner: document.getElementById('commOwner').value.trim(),
        date: new Date().toISOString().split('T')[0],
        createdAt: serverTimestamp(),
        createdBy: window.currentUser?.email || ''
      };

      try {
        await addDoc(collection(db, 'communications'), commData);

        if (window.userRole === 'admin') {
          await addDoc(collection(db, 'audit'), {
            timestamp: serverTimestamp(),
            user: window.currentUser.email,
            action: 'created',
            type: 'communication',
            details: commData.subject
          });
        }

        closeModalById('commModal');
        document.getElementById('commForm').reset();
        await loadAllData();
      } catch (error) {
        alert('Error saving communication: ' + error.message);
      }finally {
    btn.textContent = old;
    btn.disabled = false;
  }
    }

    async function saveTask(e) {
      e.preventDefault();
      const btn = document.querySelector('#taskForm button[type="submit"]');
      if (btn.disabled) return;
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      if (!currentProjectId) return alert('No project selected.');

      const taskData = {
        projectId: currentProjectId,
        name: document.getElementById('taskName').value.trim(),
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        owner: document.getElementById('taskOwner').value.trim(),
        deadline: document.getElementById('taskDeadline').value,
        createdAt: serverTimestamp(),
        createdBy: window.currentUser?.email || ''
      };

      try {
        await addDoc(collection(db, 'tasks'), taskData);

        if (window.userRole === 'admin') {
          const p = window.projects.find(x => x.id === currentProjectId);
          await addDoc(collection(db, 'audit'), {
            timestamp: serverTimestamp(),
            user: window.currentUser.email,
            action: 'created',
            type: 'task',
            details: `${taskData.name} (Project: ${p?.name || 'N/A'})`
          });
        }

        document.getElementById('taskForm').reset();
        await loadAllData();
        renderProjectViewModal(currentProjectId);
      } catch (error) {
        alert('Error saving task: ' + error.message);
      }finally {
    btn.textContent = old;
    btn.disabled = false;
  }
    }

    // ---------- Render Helpers ----------
    function badgePriority(priority){
      const key = (priority || '').toLowerCase();
      if (key === 'high') return `<span class="badge badge-high"><span class="dot" style="background:var(--danger)"></span>High</span>`;
      if (key === 'medium') return `<span class="badge badge-medium"><span class="dot" style="background:var(--warning)"></span>Medium</span>`;
      return `<span class="badge badge-low"><span class="dot" style="background:var(--primary)"></span>Low</span>`;
    }
    function badgeStatus(status){
      const s = (status || '').toLowerCase().replace(' ', '');
      const map = {
        pending: {cls:'badge-pending', label:'Pending', dot:'var(--purple)'},
        ongoing: {cls:'badge-ongoing', label:'Ongoing', dot:'var(--primary)'},
        onhold: {cls:'badge-onhold', label:'On Hold', dot:'var(--warning)'},
        completed: {cls:'badge-completed', label:'Completed', dot:'var(--success)'},
        idea: {cls:'badge-pending', label:'Idea', dot:'var(--purple)'},
        inprogress: {cls:'badge-ongoing', label:'In progress', dot:'var(--primary)'},
        pendingapproval: {cls:'badge-onhold', label:'Pending approval', dot:'var(--warning)'},
        done: {cls:'badge-completed', label:'Done', dot:'var(--success)'}
      };
      const item = map[s] || {cls:'badge-pending', label: status || 'Pending', dot:'var(--secondary)'};
      return `<span class="badge ${item.cls}"><span class="dot" style="background:${item.dot}"></span>${item.label}</span>`;
    }

    function renderDashboard() {
      const today = new Date();
      const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

      const activeProjects = window.projects.filter(p => p.status !== 'Completed').length;
      const overdueTasks = window.tasks.filter(t =>
        t.status !== 'Completed' && t.deadline && new Date(t.deadline) < today
      ).length;
      const dueThisWeek = window.tasks.filter(t => {
        if (!t.deadline) return false;
        const d = new Date(t.deadline);
        return t.status !== 'Completed' && d >= today && d <= weekFromNow;
      }).length;
      const completedTasks = window.tasks.filter(t => t.status === 'Completed').length;

      document.getElementById('activeProjects').textContent = activeProjects;
      document.getElementById('overdueTasks').textContent = overdueTasks;
      document.getElementById('dueThisWeek').textContent = dueThisWeek;
      document.getElementById('completedTasks').textContent = completedTasks;

      const highPriorityTasks = window.tasks
        .filter(t => t.priority === 'High' && t.status !== 'Completed')
        .sort((a,b) => (a.deadline||'').localeCompare(b.deadline||''))
        .slice(0, 10);

      const tbody = document.querySelector('#highPriorityTable tbody');
      tbody.innerHTML = highPriorityTasks.map(task => {
        const project = window.projects.find(p => p.id === task.projectId);
        return `
          <tr>
            <td><strong>${escapeHtml(task.name || '')}</strong></td>
            <td>${escapeHtml(project ? project.name : 'N/A')}</td>
            <td>${escapeHtml(task.owner || '')}</td>
            <td>${escapeHtml(task.deadline || '-')}</td>
            <td>${badgeStatus(task.status)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderProjects() {
      const tbody = document.querySelector('#projectsTable tbody');
      tbody.innerHTML = window.projects.map(project => {
        const projectTasks = window.tasks.filter(t => t.projectId === project.id);
        const completedCount = projectTasks.filter(t => t.status === 'Completed').length;
        const completion = projectTasks.length > 0 ? Math.round((completedCount / projectTasks.length) * 100) : 0;

        return `
          <tr>
            <td><strong>${escapeHtml(project.name || '')}</strong><div class="muted" style="font-weight:800;font-size:12px">Launch: ${escapeHtml(project.launchDate || '-')}</div></td>
            <td>${badgePriority(project.priority)}</td>
            <td>${badgeStatus(project.status)}</td>
            <td>${escapeHtml(project.owner || '')}</td>
            <td>${Number(project.budget || 0).toLocaleString()}</td>
            <td>
              <div style="font-weight:900">${completion}%</div>
              <div style="height:8px;background:var(--border);border-radius:999px;overflow:hidden;margin-top:6px">
                <div style="height:100%;background:var(--success);width:${completion}%"></div>
              </div>
            </td>
            <td>
              <button class="btn btn-primary" style="width:auto;padding:6px 12px;font-size:12px"
                data-action="viewProject" data-id="${project.id}">
                View
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderKanban() {
      const statuses = ['Pending', 'Ongoing', 'On Hold', 'Completed'];
      const counts = { Pending:0, Ongoing:0, 'On Hold':0, Completed:0 };

      statuses.forEach(status => {
        const containerId = `kanban-${status.toLowerCase().replace(' ', '')}`;
        const container = document.getElementById(containerId);
        const statusProjects = window.projects.filter(p => p.status === status);
        counts[status] = statusProjects.length;

        container.innerHTML = statusProjects.map(project => `
          <div class="kanban-card" draggable="true" data-project-id="${project.id}">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
              <strong style="display:block">${escapeHtml(project.name || '')}</strong>
              <span style="font-size:12px">${badgePriority(project.priority)}</span>
            </div>
            <div class="muted" style="font-size:12px;font-weight:800;margin-top:6px">Owner: ${escapeHtml(project.owner || '')}</div>
            <div class="muted" style="font-size:12px;font-weight:800">Launch: ${escapeHtml(project.launchDate || '-')}</div>
          </div>
        `).join('');
      });

      document.getElementById('count-pending').textContent = counts['Pending'];
      document.getElementById('count-ongoing').textContent = counts['Ongoing'];
      document.getElementById('count-onhold').textContent = counts['On Hold'];
      document.getElementById('count-completed').textContent = counts['Completed'];

      bindKanbanDragEvents();
    }

    function renderCommunications() {
      const tbody = document.querySelector('#commsTable tbody');
      tbody.innerHTML = window.communications.map(comm => {
        const pri = (comm.priority || 'Medium').toLowerCase();
        const rowClass = pri === 'high' ? 'comm-row-high' : (pri === 'low' ? 'comm-row-low' : 'comm-row-medium');
        return `
          <tr class="${rowClass}">
            <td>${escapeHtml(comm.date || '-')}</td>
            <td><strong>${escapeHtml(comm.subject || '')}</strong><div class="muted" style="font-weight:800;font-size:12px">Owner: ${escapeHtml(comm.owner || '-')}</div></td>
            <td>${escapeHtml(comm.type || '-')}</td>
            <td>${badgeStatus(comm.status)}</td>
            <td>${badgePriority(comm.priority)}</td>
            <td>${escapeHtml(comm.deadline || '-')}</td>
          </tr>
        `;
      }).join('');
    }

    function renderAnalyticsSelect(){
      const sel = document.getElementById('analyticsProjectSelect');
      const prev = sel.value;
      sel.innerHTML = `<option value="">Select a project...</option>` + window.projects
        .map(p => `<option value="${p.id}">${escapeHtml(p.name || '')}</option>`)
        .join('');
      if ([...sel.options].some(o => o.value === prev)) sel.value = prev;
      renderAnalyticsContent();
    }

    function renderAnalyticsContent(){
      const sel = document.getElementById('analyticsProjectSelect');
      const projectId = sel.value;
      const container = document.getElementById('analyticsContent');
      if (!projectId) {
        container.innerHTML = 'Pick a project to see task status breakdown.';
        return;
      }
      const p = window.projects.find(x => x.id === projectId);
      const ts = window.tasks.filter(t => t.projectId === projectId);
      const total = ts.length || 1;
      const byStatus = ['Pending','Ongoing','On Hold','Completed'].map(s => ({
        s,
        n: ts.filter(t => t.status === s).length
      }));

      container.innerHTML = `
        <div class="card" style="padding:16px;margin-top:12px">
          <div style="font-weight:900;margin-bottom:8px">${escapeHtml(p?.name || '')}</div>
          <div class="muted" style="font-weight:800;margin-bottom:12px">Total tasks: ${ts.length}</div>
          ${byStatus.map(x => `
            <div style="margin-bottom:10px">
              <div class="row-between">
                <div style="font-weight:900">${escapeHtml(x.s)}</div>
                <div class="muted" style="font-weight:900">${x.n}</div>
              </div>
              <div style="height:10px;background:var(--border);border-radius:999px;overflow:hidden;margin-top:6px">
                <div style="height:100%;background:var(--primary);width:${Math.round((x.n/total)*100)}%"></div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderAudit(){
      const tbody = document.querySelector('#auditTable tbody');
      if (window.userRole !== 'admin') {
        tbody.innerHTML = '';
        return;
      }

      tbody.innerHTML = window.audit.map(a => `
        <tr>
          <td>${a.timestamp?.toDate ? a.timestamp.toDate().toLocaleString() : '-'}</td>
          <td>${escapeHtml(a.user || '-')}</td>
          <td>${escapeHtml(a.action || '-')}</td>
          <td>${escapeHtml(a.type || '-')}</td>
          <td>${escapeHtml(a.details || '-')}</td>
        </tr>
      `).join('');
    }

    // ---------- Project View (Tasks) ----------
    function openProjectView(projectId){
      currentProjectId = projectId;
      renderProjectViewModal(projectId);
      openModal('projectViewModal');
    }

    function renderProjectViewModal(projectId){
      const p = window.projects.find(x => x.id === projectId);
      if (!p) return;

      document.getElementById('pvTitle').textContent = p.name || 'Project';
      document.getElementById('pvMeta').innerHTML = `
        ${badgePriority(p.priority)} ${badgeStatus(p.status)}
        <span class="muted" style="font-weight:900;margin-left:8px">Owner: ${escapeHtml(p.owner || '-')}</span>
        <span class="muted" style="font-weight:900;margin-left:8px">Launch: ${escapeHtml(p.launchDate || '-')}</span>
      `;

      const tasks = window.tasks
        .filter(t => t.projectId === projectId)
        .sort((a,b) => (a.deadline||'').localeCompare(b.deadline||''));

      document.getElementById('pvTaskCount').textContent = `${tasks.length} tasks`;

      const tbody = document.querySelector('#pvTasksTable tbody');
      tbody.innerHTML = tasks.map(t => `
        <tr>
          <td><strong>${escapeHtml(t.name || '')}</strong></td>
          <td>${badgePriority(t.priority)}</td>
          <td>${badgeStatus(t.status)}</td>
          <td>${escapeHtml(t.owner || '')}</td>
          <td>${escapeHtml(t.deadline || '-')}</td>
        </tr>
      `).join('');
    }

    // ---------- Kanban Drag & Drop ----------
    function bindKanbanDragEvents(){
      // Cards
      document.querySelectorAll('.kanban-card').forEach(card => {
        card.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', card.getAttribute('data-project-id'));
          e.dataTransfer.effectAllowed = 'move';
        });
      });

      // Columns
      document.querySelectorAll('.kanban-column').forEach(col => {
        col.addEventListener('dragover', (e) => {
          e.preventDefault();
          col.classList.add('drag-over');
          e.dataTransfer.dropEffect = 'move';
        });

        col.addEventListener('dragleave', () => col.classList.remove('drag-over'));

        col.addEventListener('drop', async (e) => {
          e.preventDefault();
          col.classList.remove('drag-over');
          const projectId = e.dataTransfer.getData('text/plain');
          const newStatus = col.getAttribute('data-status');
          if (!projectId || !newStatus) return;

          const p = window.projects.find(x => x.id === projectId);
          if (!p || p.status === newStatus) return;

          try {
            await updateDoc(doc(db, 'projects', projectId), { status: newStatus });

            if (window.userRole === 'admin') {
              await addDoc(collection(db, 'audit'), {
                timestamp: serverTimestamp(),
                user: window.currentUser.email,
                action: 'updated',
                type: 'project',
                details: `Moved "${p.name}" to ${newStatus}`
              });
            }

            await loadAllData();
          } catch (err) {
            alert('Could not move project: ' + err.message);
          }
        });
      });
    }

    // ---------- Calendar ----------
    function renderCalendar(){
      const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const dowEl = document.getElementById('calDow');
      dowEl.innerHTML = dow.map(d => `<div class="cal-dow">${d}</div>`).join('');

      const titleEl = document.getElementById('calTitle');
      const monthName = new Date(calYear, calMonth, 1).toLocaleString(undefined, { month: 'long', year: 'numeric' });
      titleEl.textContent = monthName;

      const grid = document.getElementById('calGrid');
      grid.innerHTML = '';

      const first = new Date(calYear, calMonth, 1);
      const startDay = first.getDay(); // 0 Sun
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

      // build date->events map
      const map = new Map(); // key YYYY-MM-DD => [{type,title}]
      const addEvent = (dateStr, evt) => {
        if (!dateStr) return;
        if (!map.has(dateStr)) map.set(dateStr, []);
        map.get(dateStr).push(evt);
      };

      // Projects on launchDate
      window.projects.forEach(p => {
        addEvent(p.launchDate, { type:'project', title: `Project: ${p.name || ''}` });
      });

      // Tasks on deadline
      window.tasks.forEach(t => {
        addEvent(t.deadline, { type:'task', title: `Task: ${t.name || ''}` });
      });

      // Leaves: span start->end
      window.leaves.forEach(l => {
        if (!l.startDate || !l.endDate) return;
        const start = new Date(l.startDate + 'T00:00:00');
        const end = new Date(l.endDate + 'T00:00:00');
        for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
          const ds = d.toISOString().split('T')[0];
          addEvent(ds, { type:'leave', title: `Leave: ${l.member || ''}` });
        }
      });

      // Comms: show on deadline (and also on comm.date)
      window.communications.forEach(c => {
        addEvent(c.deadline, { type:'comm', title: `Comms: ${c.subject || ''}` });
        addEvent(c.date, { type:'comm', title: `Comms: ${c.subject || ''}` });
      });

      const todayStr = new Date().toISOString().split('T')[0];

      // Fill leading blanks (previous month)
      for (let i=0;i<startDay;i++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell muted';
        cell.innerHTML = `<div class="cal-day"><span></span><span></span></div>`;
        grid.appendChild(cell);
      }

      // Month days
      for (let day=1; day<=daysInMonth; day++){
        const date = new Date(calYear, calMonth, day);
        const dateStr = date.toISOString().split('T')[0];

        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        const isToday = dateStr === todayStr;

        const events = (map.get(dateStr) || []).slice(0, 4); // keep simple
        const moreCount = (map.get(dateStr) || []).length - events.length;

        cell.innerHTML = `
          <div class="cal-day">
            <span style="display:flex;align-items:center;gap:8px">
              <strong>${day}</strong>
              ${isToday ? `<span class="badge badge-ongoing"><span class="dot" style="background:var(--primary)"></span>Today</span>` : ``}
            </span>
            <span class="muted" style="font-weight:900;font-size:12px">${moreCount>0?`+${moreCount} more`:``}</span>
          </div>
          <div class="cal-events">
            ${events.map(ev => renderCalPill(ev)).join('')}
          </div>
        `;
        grid.appendChild(cell);
      }

      // trailing blanks to make full weeks nice
      const totalCells = startDay + daysInMonth;
      const trailing = (7 - (totalCells % 7)) % 7;
      for (let i=0;i<trailing;i++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell muted';
        cell.innerHTML = `<div class="cal-day"><span></span><span></span></div>`;
        grid.appendChild(cell);
      }
    }

    function renderCalPill(ev){
      const title = escapeHtml(ev.title || '');
      if (ev.type === 'project') return `<div class="cal-pill pill-project" title="${title}"><span class="dot" style="background:var(--primary)"></span>${title}</div>`;
      if (ev.type === 'task') return `<div class="cal-pill pill-task" title="${title}"><span class="dot" style="background:var(--success)"></span>${title}</div>`;
      if (ev.type === 'leave') return `<div class="cal-pill pill-leave" title="${title}"><span class="dot" style="background:var(--purple)"></span>${title}</div>`;
      return `<div class="cal-pill pill-comm" title="${title}"><span class="dot" style="background:var(--cyan)"></span>${title}</div>`;
    }

    // ---------- Utility ----------
    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }


    function withButtonLoading(buttonEl, loadingText, fn) {
  return async (...args) => {
    const originalText = buttonEl.textContent;
    const originalDisabled = buttonEl.disabled;

    buttonEl.disabled = true;
    buttonEl.textContent = loadingText;

    try {
      return await fn(...args);
    } finally {
      buttonEl.textContent = originalText;
      buttonEl.disabled = originalDisabled;
    }
  };
}

    
    // ---------- Event Listeners ----------
    document.addEventListener('DOMContentLoaded', () => {
      // Auth
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('signupBtn').addEventListener('click', handleSignup);
      document.getElementById('showSignupBtn').addEventListener('click', showSignupForm);
      document.getElementById('showLoginBtn').addEventListener('click', showLoginForm);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);

      // Tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.currentTarget.getAttribute('data-tab');
          switchTab(tabName, e.currentTarget);
        });
      });

      // Modals open
      document.getElementById('newProjectBtn').addEventListener('click', () => openModal('projectModal'));
      document.getElementById('newLeaveBtn').addEventListener('click', () => openModal('leaveModal'));
      document.getElementById('newCommBtn').addEventListener('click', () => openModal('commModal'));

      // Close modals
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const modalId = e.currentTarget.getAttribute('data-modal');
          closeModalById(modalId);
        });
      });

      // Click outside modal closes
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.remove('active');
        });
      });

      // Forms
      document.getElementById('projectForm').addEventListener('submit', saveProject);
      document.getElementById('leaveForm').addEventListener('submit', saveLeave);
      document.getElementById('commForm').addEventListener('submit', saveComm);
      document.getElementById('taskForm').addEventListener('submit', saveTask);

      // Projects table button delegation (View)
      document.getElementById('projectsTable').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="viewProject"]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        openProjectView(id);
      });

      // Analytics select
      document.getElementById('analyticsProjectSelect').addEventListener('change', renderAnalyticsContent);

      // Calendar nav
      document.getElementById('calPrev').addEventListener('click', () => {
        calMonth--;
        if (calMonth < 0) { calMonth = 11; calYear--; }
        renderCalendar();
      });
      document.getElementById('calNext').addEventListener('click', () => {
        calMonth++;
        if (calMonth > 11) { calMonth = 0; calYear++; }
        renderCalendar();
      });
      document.getElementById('calToday').addEventListener('click', () => {
        const now = new Date();
        calYear = now.getFullYear();
        calMonth = now.getMonth();
        renderCalendar();
      });
    });
  </script>
</body>
</html>
